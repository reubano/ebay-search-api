language: python
python:
  - '2.7'

notifications:
  email:
    on_success: always

before_install: sudo apt-get install libevent-dev
install: pip install -r requirements/test.txt

before_script:
  - openssl aes-256-cbc -d -k "$secret" -in envs.yml.enc -a -out envs.yml

script: python manage.py test
after_success:
  # check for pull request and correct python version
  - if [[ "$TRAVIS_PULL_REQUEST" == "true" ]]; then exit 0; fi
  - if [[ "$TRAVIS_PYTHON_VERSION" != "2.7" ]]; then exit 0; fi

  # Install heroku toolbelt
  - wget -qO- https://toolbelt.heroku.com/install-ubuntu.sh | sh

  # check branch to conditionally add remote repo
  - REPO_NAME=`basename $TRAVIS_REPO_SLUG`
  - if [[ "$TRAVIS_BRANCH" == "master" ]]; then git remote add production git@heroku.com:${REPO_NAME}.git; fi
  - if [[ "$TRAVIS_BRANCH" == "features" ]]; then git remote add staging git@heroku.com:${REPO_NAME}-stage.git; fi

  # Turn off warnings about SSH keys:
  - echo "Host heroku.com" >> ~/.ssh/config
  - echo "   StrictHostKeyChecking no" >> ~/.ssh/config
  - echo "   CheckHostIP no" >> ~/.ssh/config
  - echo "   UserKnownHostsFile=/dev/null" >> ~/.ssh/config
  - heroku keys:clear
  - yes | heroku keys:add

  # check branch for conditional push
  - if [[ "$TRAVIS_BRANCH" == "master" ]]; then yes | git push production master; fi
  - if [[ "$TRAVIS_BRANCH" == "features" ]]; then yes | git push staging features:master; fi

env:
  global:
  - secure: Ngem5DLc2hunGbazgciwRImGGDJgZZfHwk0FtxbYUlwj+C5KwN9oOagFWQPI2XU/brKx6vVOdjUW5ZLwyit893T02sw4FI4DR4TRPTkbXUl92+LAvub54JuxryzPxNZxyPS0pV3e7fyQjLLggZNBviKZ/+CHwFtmnHSXHVJWPFk=
  - secure: iTWueWXEyiWqu5HjrM2GXyyO3rNu/k0MGcU1n5aBwQ61J9T1LGBTyhDCNsyg8UQ720upWbiDoDho/28UadC9VzNTj0GGUGRn6FillMpg6g8DTsELJ9vmzSU4RyD/WlbPp9dKCLjbIEmxJOhtv9z4oB9uDZLao54bwTnqw3z2CGY=
  - secure: b2LackUXhQ3jX0gR+G4Fa+lP0mxfR58bC2+KJG7qiWrdqTT5tMz5XVKJw+xEVSA/OQSiKUD+LP53rQQWHc8THQGfES2ncAS+Jeh/hqcQKaSNhofZvtXAGw5KOfXp8TfyuSnDILDjVFPyfsKRrOGM4dCZlRgrZyp768jbqVUapXg=
  - secure: DyrvsGj9E7IbFFb1jQaTNWz+BCRhkEvDOoleIVTeLHFqk1WHPBrsEjk14RIppViPoeGnPfSaATTTeJ3Yegb7KCHVKI33RQkgEsbOZJ+ryUIgFdhBjhUDnBL/2lAkHtV1yxeQ7eIeqIdKrpI9hfwlBbsx2sJYPUqLKaCSuFTJ8+k=
  - secure: AsJeUy0JcuZYfktDGPyK78o0JB0eHsiFcb9fDjWu775FCHbmrdGymbEo7jBnCBOPyFwcoJ9yec3j516zBGRSDOoO5wclZQLJiqFsAjhgN1gD/3tzoQik1Htyei1ABqezHZv6iLsfhzJCL/wH6ze0q3/kDDPH+XeZXQkZuY6G77o=
  - secure: hpMRfqEZJ4gYohmypgA/6O/kiQM7eLVvQxSRnqL+lXhAzPPcXuxb0m4LfskvX3OSnz0nm3uqhKzb2NzhvRq0Ce9SPKitkGDpc1cxeY1nVdLiFmY1HZ0hQQo2ExjKEedddmApMq9QZYRDGej5XoVsBYd10x//8OejWutXQC4Bp3E=
  - secure: hYmX7RC5wgmaE0N1hoEpZFI9LO2eyBFOlxCzbmMvukYtYgG7zZUlpNItvVZ4B64rMUq9v52TOb0H7e89dntYsmsle8UlFWOPqZp8vEoRsd2M8RuHhFRdKbQfPvDiV02n7ZGOaACpPI5zvRvY2XUj/XArpREr5tfzU2lvNIGE/yw=
